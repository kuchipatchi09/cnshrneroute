<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>최적 경로 그리기</title>

  <!-- Pretendard 폰트 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet-polylinedecorator@1.7.0/dist/leaflet.polylineDecorator.min.js"></script>

  <style>
    :root{
      --bg: #f7fafc;
      --card: #ffffff;
      --panel: #f1f5f9;
      --ink: #0f172a;
      --muted: #475569;
      --accent: #2563eb;
      --accent-2: #7c3aed;
      --border: #e6edf3;
      --chip: #eef2ff;
      --success: #16a34a;
      --danger: #ef4444;
      --glass: rgba(255,255,255,0.6);
    }

    /* 전체 Pretendard 적용 (Regular 기본) */
    html,body{
      height:100%;
    }
    body {
      margin:0;
      background: linear-gradient(180deg,#f8fbff 0%, var(--bg) 100%);
      color:var(--ink);
      font-family: "Pretendard", system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial;
      font-weight:400;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-tap-highlight-color:transparent;
    }

    /* App header */
    header {
      padding:18px 22px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      background: linear-gradient(90deg, rgba(255,255,255,0.7), rgba(255,255,255,0.95));
      position:sticky;
      top:0;
      z-index:30;
      backdrop-filter: blur(6px);
      box-shadow: 0 1px 0 rgba(16,24,40,0.02);
    }

    /* 사이트 제목: Pretendard Bold */
    header h1{
      margin:0;
      font-size:19px;
      font-weight:700; /* Bold */
      letter-spacing:0.2px;
      color:var(--ink);
    }

    .chip {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background:var(--chip);
      color:#3730a3;
      font-size:12px;
      border:1px solid rgba(55,48,163,0.08);
      box-shadow: 0 1px 3px rgba(15,23,42,0.03);
    }

    /* Layout */
    .container {
      display:grid;
      grid-template-columns:420px 1fr;
      gap:0;
      height:calc(100vh - 66px);
    }

    /* Left panel */
    .panel {
      background: transparent;
      padding:16px;
      border-right:0;
      overflow:auto;
      box-shadow: inset -1px 0 0 var(--border);
    }

    .panel > section {
      background: var(--card);
      border-radius:12px;
      padding:16px;
      margin-bottom:14px;
      border:1px solid var(--border);
      box-shadow: 0 6px 18px rgba(16,24,40,0.03);
    }

    .panel h2 {
      font-size:12px;
      margin:0 0 10px 0;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.08em;
    }

    label { font-size:13px; color:var(--muted); display:block; margin:6px 0 6px; }

    input[type="text"], textarea, select {
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--ink);
      font-size:14px;
      outline:none;
      transition: box-shadow .12s, border-color .12s;
    }

    input[type="text"]:focus, textarea:focus, select:focus{
      box-shadow: 0 6px 18px rgba(37,99,235,0.06);
      border-color: rgba(37,99,235,0.28);
    }

    textarea { resize:vertical; min-height:140px; font-family: "Pretendard", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    .row { display:flex; gap:8px; align-items:center; }

    .btn {
      display:inline-flex;
      align-items:center;
      gap:8px;
      background: linear-gradient(180deg,#0f172a 0%, #111827 100%);
      color:#fff;
      border: none;
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      box-shadow: 0 8px 24px rgba(15,23,42,0.12);
    }

    .btn.secondary {
      background:#fff;
      color:var(--ink);
      border:1px solid var(--border);
      font-weight:600;
      box-shadow:none;
    }

    .btn:active{ transform: translateY(1px); }

    .hint { font-size:12px; color:var(--muted); margin-top:6px; }

    .stats {
      font-size:13px;
      line-height:1.5;
      background: linear-gradient(180deg,#ffffff,#fbfdff);
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      color:var(--ink);
    }

    .table {
      width:100%;
      border-collapse: collapse;
      font-size:13px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:10px;
      overflow:hidden;
      box-shadow:0 6px 18px rgba(2,6,23,0.02);
    }

    .table thead { background: linear-gradient(90deg, rgba(240,249,255,0.6), rgba(255,255,255,0.6)); }
    .table th, .table td {
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      text-align:left;
    }

    .num-label {
      background: var(--danger);
      color:#fff;
      border-radius:8px;
      padding:3px 7px;
      font-size:12px;
      border:1px solid rgba(0,0,0,0.06);
      font-weight:700;
    }

    .footer { font-size:12px; color:var(--muted); }

    /* Map area */
    #map {
      height: calc(100vh - 66px);
      width:100%;
    }

    /* Responsive */
    @media (max-width:980px){
      .container { grid-template-columns: 1fr; grid-auto-rows: minmax(120px, auto); }
      #map { height:60vh; }
      .panel { order:2; height:auto; }
    }
  </style>
</head>
<body>
  <header>
    <h1>최적경로 그리기</h1>
    <div class="chip" id="statusPill">Idle</div>
  </header>

  <div class="container">
    <div class="panel">
      <section>
        <h2>Config</h2>
        <div class="row" style="margin-top:6px;">
          <div style="flex:1">
            <label>Profile</label>
            <select id="profile">
              <option value="driving-car" selected>driving-car</option>
              <option value="foot-walking">foot-walking</option>
              <option value="cycling-regular">cycling-regular</option>
            </select>
          </div>
          <div style="width:120px">
            <label>Zoom</label>
            <input id="zoomStart" type="text" value="14" />
          </div>
        </div>
        <div class="hint" style="margin-top:10px;">주소/좌표 입력 지원 — 출발지와 목록을 스냅해서 시작합니다.</div>
      </section>

      <section>
        <h2>Start</h2>
        <label>출발지 (주소 또는 "위도,경도")</label>
        <input id="startInput" type="text" placeholder="예: 36.813652,127.108917" />
        <div class="row" style="margin-top:8px;">
          <div style="flex:1">
            <label>시작 인덱스(백업)</label>
            <input id="startIndex" type="text" value="0" />
          </div>
          <div style="flex:1">
            <label>좌표 스냅 허용오차(m)</label>
            <input id="tolMeters" type="text" value="25" />
          </div>
        </div>
      </section>

      <section>
        <h2>Points</h2>
        <label>각 지점을 한 줄에 하나씩 입력 (예: "부산역" 또는 "35.101934,129.030607")</label>
        <textarea id="pointsBox" placeholder="예:&#10;부산역&#10;35.101934,129.030607&#10;광안리 해수욕장"></textarea>
        <label style="margin-top:8px;">라벨 (쉼표로 구분, 비우면 자동)</label>
        <input id="labelsBox" type="text" placeholder="A,B,C,D,..." />
        <div class="row" style="margin-top:12px; gap:12px;">
          <button class="btn" id="runBtn">최단 오픈 경로 그리기</button>
          <button class="btn secondary" id="clearBtn">초기화</button>
        </div>
      </section>

      <section>
        <h2>Results</h2>
        <div class="stats" id="stats"></div>
        <div style="margin-top:12px;">
          <table class="table" id="resultTable">
            <thead><tr><th style="width:44px">#</th><th>Label</th><th>Lat</th><th>Lon</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="footer" style="margin-top:10px;">오픈 경로(복귀 없음), 최근접이웃 → 2-opt. ORS Matrix/Directions + Leaflet.</div>
      </section>
    </div>

    <div id="map"></div>
  </div>

  <script>
    const API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjVlMmRiZDNmOWQwMjQyYTc5NTdiNzFlOWZiNzRiNjg2IiwiaCI6Im11cm11cjY0In0=";

    const $ = (sel) => document.querySelector(sel);
    const setStatus = (msg) => (document.querySelector("#statusPill").textContent = msg);

    function isLatLonLine(s){ const m = s.split(/[ ,]+/).map(x=>x.trim()); return m.length >= 2 && !isNaN(parseFloat(m[0])) && !isNaN(parseFloat(m[1])); }
    function parseLatLon(s){ const m=s.split(/[ ,]+/).map(x=>x.trim()); return [parseFloat(m[0]), parseFloat(m[1])]; }
    function ensureLonLat(latlon){ return latlon.map(([lat,lon])=>[lon,lat]); }

    async function orsGeocode(text){
      const url = new URL('https://api.openrouteservice.org/geocode/search');
      url.searchParams.set('api_key', API_KEY);
      url.searchParams.set('text', text);
      url.searchParams.set('size', '1');
      const r = await fetch(url);
      if(!r.ok) throw new Error(`Geocode 실패: ${r.status}`);
      const j = await r.json();
      const feat = j.features?.[0];
      if(!feat) throw new Error(`지오코드 실패: ${text}`);
      const [lon,lat]=feat.geometry.coordinates;
      return [lat,lon];
    }

    async function orsMatrix(profile, coordsLonLat){
      const r = await fetch(`https://api.openrouteservice.org/v2/matrix/${profile}`, {
        method:'POST', headers:{'Authorization':API_KEY,'Content-Type':'application/json'},
        body:JSON.stringify({ locations: coordsLonLat, metrics:['distance'], resolve_locations:true })
      });
      if(!r.ok) throw new Error(`Matrix 실패: ${r.status}`);
      const j = await r.json();
      return j.distances;
    }

    async function orsDirections(profile, aLonLat, bLonLat){
      const r = await fetch(`https://api.openrouteservice.org/v2/directions/${profile}/geojson`, {
        method:'POST', headers:{'Authorization':API_KEY,'Content-Type':'application/json'},
        body:JSON.stringify({ coordinates:[aLonLat,bLonLat] })
      });
      if(!r.ok) throw new Error(`Directions 실패: ${r.status}`);
      return await r.json();
    }

    function normalizeLabels(lblStr,n){ if(!lblStr) return Array.from({length:n},(_,i)=>`Point ${i+1}`); const arr=lblStr.split(',').map(s=>s.trim()).filter(Boolean); return arr.length===n?arr:Array.from({length:n},(_,i)=>arr[i]??`Point ${i+1}`); }

    async function resolvePointsFromTextarea(){
      const lines = $("#pointsBox").value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      if(lines.length < 2) throw new Error('지점은 2개 이상 입력하세요.');
      const out = [];
      for(const line of lines){
        if(isLatLonLine(line)) out.push(parseLatLon(line));
        else out.push(await orsGeocode(line));
      }
      return out;
    }

    function nearestNeighborOpen(M,start=0){
      const n=M.length, visited=Array(n).fill(false); const route=[start]; visited[start]=true; let cur=start;
      for(let step=0;step<n-1;step++){
        let best=-1,bestD=Infinity;
        for(let j=0;j<n;j++){ if(!visited[j] && j!==cur){ const d=M[cur][j]; if(d<bestD){bestD=d;best=j;} } }
        route.push(best); visited[best]=true; cur=best;
      } return route;
    }

    function twoOptOpen(route,M,fixStart=true){
      const n=route.length; const pathLen=r=>r.slice(0,-1).reduce((a,_,i)=>a+M[r[i]][r[i+1]],0);
      let best=route.slice(), bestLen=pathLen(best), improved=true, startI=fixStart?1:0;
      while(improved){ improved=false; for(let i=startI;i<n-2;i++){ for(let k=i+1;k<n-1;k++){ const nr=best.slice(0,i).concat(best.slice(i,k+1).reverse(),best.slice(k+1)); const nl=pathLen(nr); if(nl+1e-9<bestLen){best=nr;bestLen=nl;improved=true;} } } }
      return {route:best, meters:bestLen};
    }

    let map=L.map('map').setView([36.813652,127.108917],14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20}).addTo(map);
    const drawnLayer=L.layerGroup().addTo(map);
    function clearMap(){ drawnLayer.clearLayers(); }

    function drawMarkers(coordsLatLon,labels,route){
      route.forEach((idx,order)=>{
        const [lat,lon]=coordsLatLon[idx];
        const m=L.marker([lat,lon]).addTo(drawnLayer);
        m.bindPopup(`${order+1}번째: ${labels[idx]}`);
        const el=document.createElement('div'); el.className='num-label'; el.textContent=String(order+1);
        L.marker([lat,lon],{icon:L.divIcon({className:'',html:el,iconSize:[28,18]})}).addTo(drawnLayer);
      });
      const s=route[0], e=route[route.length-1];
      L.circleMarker(coordsLatLon[s], { radius:8, color: 'var(--success)' }).addTo(drawnLayer).bindTooltip('출발지');
      L.circleMarker(coordsLatLon[e], { radius:8, color: 'var(--danger)' }).addTo(drawnLayer).bindTooltip('도착지');
    }

    async function drawDirections(profile,coordsLonLat,route){
      for(let i=0;i<route.length-1;i++){
        const a=coordsLonLat[route[i]], b=coordsLonLat[route[i+1]];
        try{
          const gj=await orsDirections(profile,a,b);
          const coords=gj.features[0].geometry.coordinates.map(([lon,lat])=>[lat,lon]);
          const line=L.polyline(coords,{weight:4}).addTo(drawnLayer);
          L.polylineDecorator(line,{patterns:[{offset:7,repeat:40,symbol:L.Symbol.arrowHead({pixelSize:10,pathOptions:{weight:2}})}]}).addTo(drawnLayer);
        }catch(e){ console.warn('
